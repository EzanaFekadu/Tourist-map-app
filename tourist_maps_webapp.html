<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TouristMaps - Discover & Explore</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f172a;
            color: #f8fafc;
            overflow: hidden;
        }

        body.light-mode {
            background: #f8fafc;
            color: #0f172a;
        }

        html, body {
            width: 100vw;
            height: 100vh;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        .sidebar {
            width: 100vw;
            min-width: 0;
            max-width: 100vw;
            border-radius: 0 0 18px 18px;
            box-shadow: 0 4px 32px rgba(0,0,0,0.18);
            position: relative;
            z-index: 1000;
            padding-bottom: 0;
        }

        .header {
            padding: 24px 16px 14px 16px;
            border-radius: 0 0 0 0;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tagline {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .search-section,
        .route-options,
        .map-layers,
        .attractions {
            padding-left: 16px;
            padding-right: 16px;
        }

        .search-section {
            padding: 20px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #cbd5e1;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            color: #f8fafc;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: 2px solid #3b82f6 !important;
            outline-offset: 2px;
        }

        .route-options {
            padding: 20px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .route-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .route-btn {
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            color: #cbd5e1;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        body.light-mode .route-btn,
        body.light-mode .transport-btn,
        body.light-mode .layer-btn {
            background: #f8fafc !important;
            color: #0f172a !important;
            border-color: #cbd5e1 !important;
        }

        body.light-mode .route-btn.active,
        body.light-mode .transport-btn.active,
        body.light-mode .layer-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%) !important;
            color: #fff !important;
        }

        .route-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .route-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-color: #3b82f6;
            color: white;
        }

        .transport-options {
            padding: 20px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .transport-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .transport-btn {
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            color: #cbd5e1;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .transport-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .transport-btn.active {
            background: linear-gradient(135deg, #f59e42 0%, #f472b6 100%);
            border-color: #f59e42;
            color: white;
        }

        .map-layers {
            padding: 20px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .layer-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .layer-btn {
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            color: #cbd5e1;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .layer-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .layer-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: #10b981;
            color: white;
        }

        .attractions {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .attraction-item {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        body.light-mode .attraction-item {
            background: #f8fafc !important;
            color: #0f172a !important;
            border-color: #cbd5e1 !important;
        }

        .attraction-item:hover {
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .attraction-name {
            font-size: 14px;
            font-weight: 600;
            color: #f8fafc;
            margin-bottom: 4px;
        }

        .attraction-type {
            font-size: 12px;
            color: #3b82f6;
            margin-bottom: 6px;
            font-weight: 500;
        }

        body.light-mode .attraction-type {
            color: #3b82f6 !important;
        }

        .attraction-distance {
            font-size: 11px;
            color: #94a3b8;
        }

        body.light-mode .attraction-distance,
        body.light-mode .stat-label {
            color: #64748b !important;
        }

        .map-container {
            flex: 1;
            min-height: 300px;
            position: relative;
            width: 100vw;
            height: 100%;
        }

        #map {
            width: 100vw;
            height: 60vh;
            min-height: 300px;
        }

        .map-controls {
            position: absolute;
            bottom: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1200;
        }

        @media (max-width: 768px) {
            .map-controls {
                flex-direction: row;
                bottom: 16px;
                right: 16px;
                left: unset;
                top: unset;
                gap: 8px;
            }
        }

        .control-btn {
            width: 44px;
            height: 44px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            color: #f8fafc;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: rgba(59, 130, 246, 0.9);
            border-color: #3b82f6;
            transform: scale(1.05);
        }

        .floating-panel {
            position: absolute;
            left: 8px;
            right: 8px;
            bottom: 80px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 14px;
            color: #f8fafc;
            z-index: 1000;
            display: none;
        }

        .route-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .route-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-weight: 600;
            color: #3b82f6;
        }

        .stat-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(148, 163, 184, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);
            width: 0%;
            transition: width 2s ease;
        }

        .leaflet-popup-content-wrapper {
            background: rgba(15, 23, 42, 0.95);
            color: #f8fafc;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .leaflet-popup-content {
            margin: 12px 16px;
            font-size: 14px;
        }

        .popup-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #3b82f6;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 350px;
                position: absolute;
                left: -100%;
                transition: left 0.3s ease;
                z-index: 2000;
            }

            .sidebar.open {
                left: 0;
            }

            .mobile-toggle {
                display: block !important;
                position: absolute;
                top: 16px;
                left: 16px;
                z-index: 1100;
                background: rgba(15, 23, 42, 0.95);
                border: 1px solid rgba(148, 163, 184, 0.2);
                border-radius: 8px;
                padding: 8px 12px;
                color: #f8fafc;
                font-size: 20px;
                cursor: pointer;
            }
        }

        /* --- Mobile-First Enhancements --- */

        /* Base styles: assume mobile first */
        body, html {
            width: 100vw;
            height: 100vh;
            min-height: 100vh;
            overflow-x: hidden;
            background: #0f172a;
        }

        .container {
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        .sidebar {
            width: 100vw;
            min-width: 0;
            max-width: 100vw;
            border-radius: 0 0 18px 18px;
            box-shadow: 0 4px 32px rgba(0,0,0,0.18);
            position: relative;
            z-index: 1000;
            padding-bottom: 0;
        }

        .header {
            padding: 24px 16px 14px 16px;
            border-radius: 0 0 0 0;
        }

        .search-section,
        .route-options,
        .map-layers,
        .attractions {
            padding-left: 16px;
            padding-right: 16px;
        }

        .map-container {
            flex: 1;
            min-height: 300px;
            position: relative;
            width: 100vw;
            height: 100%;
        }

        #map {
            width: 100vw;
            height: 60vh;
            min-height: 300px;
        }

        .map-controls {
            position: absolute;
            bottom: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1200;
        }

        @media (max-width: 768px) {
            .map-controls {
                flex-direction: row;
                bottom: 16px;
                right: 16px;
                left: unset;
                top: unset;
                gap: 8px;
            }
        }

        .floating-panel {
            left: 8px;
            right: 8px;
            bottom: 80px;
            border-radius: 12px;
            padding: 14px;
        }

        .mobile-toggle {
            display: block !important;
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 1100;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: #f8fafc;
            font-size: 20px;
            cursor: pointer;
        }

        .sidebar {
            position: absolute;
            top: 0;
            left: -100vw;
            height: 100vh;
            transition: left 0.3s cubic-bezier(.4,0,.2,1);
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            overflow-y: auto;
        }
        .sidebar.open {
            left: 0;
        }

        @media (min-width: 769px) {
            .container {
                flex-direction: row;
            }
            .sidebar {
                position: relative;
                width: 370px;
                max-width: 370px;
                left: 0;
                border-radius: 0 18px 18px 0;
                height: 100vh;
                overflow-y: auto;
            }
            .map-container {
                height: 100vh;
                width: calc(100vw - 370px);
            }
            #map {
                height: 100vh;
                width: 100%;
            }
            .map-controls {
                flex-direction: column;
                top: 20px;
                bottom: unset;
                right: 20px;
                left: unset;
            }
            .floating-panel {
                left: 24px;
                right: 24px;
                bottom: 24px;
                border-radius: 18px;
                padding: 24px;
            }
            .mobile-toggle {
                display: none !important;
            }
        }

        .recent-favorites {
            padding: 20px 16px 0 16px;
        }
        .recent-item, .favorite-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(15,23,42,0.5);
            border-radius: 8px;
            padding: 6px 12px;
            margin-bottom: 6px;
            font-size: 13px;
            cursor: pointer;
        }
        .recent-item:hover, .favorite-item:hover {
            background: rgba(59,130,246,0.1);
        }
        .star-btn {
            background: none;
            border: none;
            color: #f59e42;
            font-size: 16px;
            cursor: pointer;
        }
        .star-btn.filled {
            color: #fbbf24;
        }

        @media print {
    body * {
        visibility: hidden !important;
    }
    #map, #routePanel, #map * , #routePanel * {
        visibility: visible !important;
    }
    #map {
        position: absolute !important;
        left: 0; top: 0; width: 100vw; height: 60vh !important;
    }
    #routePanel {
        position: absolute !important;
        left: 0; right: 0; bottom: 0; width: 100vw;
        background: #fff !important;
        color: #222 !important;
        box-shadow: none !important;
    }
}

@keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="header">
                <div class="logo">
                    🗺️ TouristMaps
                </div>
                <div class="tagline">Discover amazing places on your journey</div>
                <button id="themeToggle" title="Toggle dark/light mode" style="float:right; background:none; border:none; font-size:20px; cursor:pointer; color:#f8fafc;">🌙</button>
            </div>

            <div class="search-section">
                <div class="input-group">
                    <label class="input-label" id="fromLabel">From</label>
                    <input type="text" class="input-field" id="fromInput" placeholder="Enter starting location">
                </div>
                <div class="input-group">
                    <label class="input-label" id="toLabel">To</label>
                    <input type="text" class="input-field" id="toInput" placeholder="Enter destination">
                </div>
            </div>

            <div class="route-options">
                <div class="section-title" id="routeTypeLabel">Route Type</div>
                <div class="route-buttons" role="group" aria-label="Route type">
                    <button class="route-btn active" data-route="fastest" id="fastestRouteBtn">⚡ Fastest</button>
                    <button class="route-btn" data-route="shortest" id="shortestRouteBtn">📏 Shortest</button>
                    <button class="route-btn" data-route="scenic" id="scenicRouteBtn">🌄 Scenic</button>
                    <button class="route-btn" data-route="tourist" id="touristRouteBtn">🎯 Tourist</button>
                </div>
            </div>

            <div class="transport-options">
                <div class="section-title" id="transportModeLabel">Transport Mode</div>
                <div class="transport-buttons" role="group" aria-label="Transport mode">
                    <button class="transport-btn active" data-mode="driving" id="drivingTransportBtn">🚗 Driving</button>
                    <button class="transport-btn" data-mode="walking" id="walkingTransportBtn">🚶 Walking</button>
                    <button class="transport-btn" data-mode="cycling" id="cyclingTransportBtn">🚴 Cycling</button>
                    <button class="transport-btn" data-mode="rail" id="railTransportBtn">🚆 Rail</button>
                    <button class="transport-btn" data-mode="flying" id="flyingTransportBtn">✈️ Flying</button>
                </div>
            </div>

            <div class="map-layers">
                <div class="section-title" id="mapLayersLabel">Map Layers</div>
                <div class="layer-buttons">
                    <button class="layer-btn active" data-layer="standard" id="standardLayerBtn">🗺️ Standard</button>
                    <button class="layer-btn" data-layer="satellite" id="satelliteLayerBtn">🛰️ Satellite</button>
                    <button class="layer-btn" data-layer="terrain" id="terrainLayerBtn">⛰️ Terrain</button>
                    <button class="layer-btn" data-layer="traffic" id="trafficLayerBtn">🚦 Traffic</button>
                    <button class="layer-btn" data-layer="transit" id="transitLayerBtn">🚋 Transit</button>
                </div>
            </div>

            <div class="attractions">
                <div class="section-title" id="nearbyAttractionsLabel">Nearby Attractions</div>
                <div id="attractionsList">
                </div>
            </div>

            <!-- Add after .search-section -->
            <div class="recent-favorites">
                <div class="section-title" id="recentFavoritesLabel">Recent & Favorites</div>
                <div id="recentList"></div>
                <div id="favoritesList"></div>
            </div>
        </div>

        <div class="map-container">
            <button class="mobile-toggle" id="mobileToggle" style="display: none;">☰</button>
            <div id="map"></div>
            
            <div class="map-controls" role="group" aria-label="Map controls">
                <button class="control-btn" id="locationBtn" title="My Location" aria-label="My Location" tabindex="0">📍</button>
                <button class="control-btn" id="weatherBtn" title="Show Weather" aria-label="Show Weather" tabindex="0">☁️</button>
            </div>

            <div class="floating-panel" id="routePanel">
                <div class="route-info">
                    <div class="route-stats">
                        <div class="stat">
                            <div class="stat-value" id="routeDistance">12.4 mi</div>
                            <div class="stat-label">Distance</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="routeTime">28 min</div>
                            <div class="stat-label">Time</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="routeAttractions">5</div>
                            <div class="stat-label">Attractions</div>
                        </div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <button id="shareRouteBtn" class="control-btn" style="margin-top:12px;width:auto;padding:8px 18px;font-size:14px;">🔗 Share Route</button>
                <!-- Add after the share button in .floating-panel -->
                <button id="printRouteBtn" class="control-btn" style="margin-top:12px;width:auto;padding:8px 18px;font-size:14px;">🖨️ Print/Export</button>
                <div id="waypointsContainer"></div>
                <button id="addWaypointBtn" class="control-btn" style="margin:8px 0 0 0;width:auto;padding:8px 18px;font-size:14px;">➕ Add Stop</button>
            </div>
        </div>
    </div>

    <div id="globalLoading" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:3000;background:rgba(15,23,42,0.5);align-items:center;justify-content:center;">
    <div style="background:#fff;padding:24px 32px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.18);color:#3b82f6;font-size:18px;display:flex;align-items:center;gap:12px;">
        <span class="spinner" style="width:24px;height:24px;border:3px solid #3b82f6;border-top:3px solid #f8fafc;border-radius:50%;display:inline-block;animation:spin 1s linear infinite;"></span>
        Loading...
    </div>
</div>
<div id="weatherPanel" style="display:none;position:absolute;top:24px;right:24px;z-index:2001;background:rgba(15,23,42,0.97);color:#f8fafc;padding:18px 22px;border-radius:12px;box-shadow:0 4px 24px rgba(0,0,0,0.18);min-width:180px;font-size:15px;"></div>

    <script src="config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>
    <script>
        // --- Constants ---
        const DEFAULT_LAT = 40.7128;
        const DEFAULT_LNG = -74.0060;
        const DEFAULT_ZOOM = 13;
        const NOMINATIM_URL = 'https://nominatim.openstreetmap.org/search?format=json';
        const OSRM_URL = 'https://router.project-osrm.org/route/v1';
        const USER_AGENT = 'TouristMaps/1.0';
        const NEARBY_ATTRACTION_RADIUS_KM = 5;
        const EARTH_RADIUS_KM = 6371;
        const NOMINATIM_SEARCH_LIMIT = 5;
        const DISPLAY_ATTRACTION_LIMIT = 10;
        const ROUTE_NEARBY_DISTANCE_THRESHOLD = 0.02; // Approx 2km in crude lat/lng distance
        const DEFAULT_ATTRACTIONS_COUNT_FALLBACK = 5;
        const MIN_GENERATED_ATTRACTIONS = 8;
        const MAX_GENERATED_ATTRACTIONS_RANDOM = 5;
        const INITIAL_LOAD_DELAY = 1000;
        const MARKER_ICON_SIZE = [20, 20];
        const POPUP_TEXT_COLOR = '#94a3b8';
        const POPUP_TEXT_SIZE = '12px';
        const POPUP_TEXT_MARGIN_TOP = '4px';

        // --- Translations ---
        const translations = {
    en: {
        from: "From",
        to: "To",
        routeType: "Route Type",
        fastest: "⚡ Fastest",
        shortest: "📏 Shortest",
        scenic: "🌄 Scenic",
        tourist: "🎯 Tourist",
        transportMode: "Transport Mode",
        driving: "🚗 Driving",
        walking: "🚶 Walking",
        cycling: "🚴 Cycling",
        rail: "🚆 Rail",
        flying: "✈️ Flying",
        mapLayers: "Map Layers",
        standard: "🗺️ Standard",
        satellite: "🛰️ Satellite",
        terrain: "⛰️ Terrain",
        traffic: "🚦 Traffic",
        transit: "🚋 Transit",
        attractions: "Nearby Attractions",
        recentFavorites: "Recent & Favorites",
        shareRoute: "🔗 Share Route",
        printExport: "🖨️ Print/Export",
        addStop: "➕ Add Stop",
        weather: "Weather",
        myLocation: "My Location",
        showWeather: "Show Weather"
    },
    es: {
        from: "Desde",
        to: "Hasta",
        routeType: "Tipo de Ruta",
        fastest: "⚡ Más rápida",
        shortest: "📏 Más corta",
        scenic: "🌄 Escénica",
        tourist: "🎯 Turística",
        transportMode: "Modo de Transporte",
        driving: "🚗 Coche",
        walking: "🚶 A pie",
        cycling: "🚴 Bicicleta",
        rail: "🚆 Tren",
        flying: "✈️ Avión",
        mapLayers: "Capas de Mapa",
        standard: "🗺️ Estándar",
        satellite: "🛰️ Satélite",
        terrain: "⛰️ Terreno",
        traffic: "🚦 Tráfico",
        transit: "🚋 Transporte",
        attractions: "Atracciones Cercanas",
        recentFavorites: "Recientes y Favoritos",
        shareRoute: "🔗 Compartir Ruta",
        printExport: "🖨️ Imprimir/Exportar",
        addStop: "➕ Añadir Parada",
        weather: "Clima",
        myLocation: "Mi Ubicación",
        showWeather: "Mostrar Clima"
    }
};

        // --- Map Initialization ---
        const map = L.map('map').setView([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);

        const layers = {
            standard: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles © Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | © <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
            }),
            transit: null // Managed with dynamic markers
        };

        layers.standard.addTo(map);
        let currentLayer = 'standard';
        let transitMarkers = [];

        // --- Hide/disable traffic button ---
        document.querySelectorAll('.layer-btn').forEach(btn => {
            if (btn.dataset.layer === 'traffic') {
                btn.disabled = true;
                btn.style.opacity = 0.5;
                btn.title = "No free, global, real-time traffic layer is available.";
            }
        });

        // --- Transport mode logic ---
        let currentTransportMode = loadPreference('transportMode', 'driving');
        document.querySelectorAll('.transport-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.transport-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTransportMode = btn.dataset.mode;
                savePreference('transportMode', currentTransportMode);
                updateRoute();
            });
        });

        // --- Route type logic (for demonstration, just UI) ---
        let currentRouteType = loadPreference('routeType', 'fastest');
        document.querySelectorAll('.route-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.route-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentRouteType = btn.dataset.route;
                savePreference('routeType', currentRouteType);
                updateRoute();
            });
        });

        // --- Layer button handlers ---
        document.querySelectorAll('.layer-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const layerType = btn.dataset.layer;
                savePreference('mapLayer', layerType);
                if (currentLayer === 'transit') {
                    transitMarkers.forEach(marker => map.removeLayer(marker));
                }
                if (layerType === 'traffic') {
                    alert('No free, global, real-time traffic layer is available.');
                    document.querySelectorAll('.layer-btn').forEach(b => {
                        if (b.dataset.layer === currentLayer) b.classList.add('active');
                        else b.classList.remove('active');
                    });
                    return;
                }
                if (layerType === 'transit') {
                    const center = map.getCenter();
                    showTransitStops(center.lat, center.lng);
                    currentLayer = 'transit';
                } else {
                    if (layers[currentLayer] && map.hasLayer(layers[currentLayer])) {
                        map.removeLayer(layers[currentLayer]);
                    }
                    if (layers[layerType]) {
                        layers[layerType].addTo(map);
                    }
                    currentLayer = layerType;
                }
            });
        });

        map.on('moveend', function() {
            if (currentLayer === 'transit') {
                const center = map.getCenter();
                showTransitStops(center.lat, center.lng);
            }
        });

        // --- FIX 1: Remove duplicate marker logic and ensure only one attraction marker at a time ---
        let currentAttractionMarker = null;

        // Attraction item click handlers
        document.querySelectorAll('.attraction-item').forEach((item, index) => {
            item.addEventListener('click', async () => {
                const attraction = attractions[index];
                map.setView([attraction.lat, attraction.lng], 16);

                // Remove previous marker if exists
                if (currentAttractionMarker) {
                    map.removeLayer(currentAttractionMarker);
                }
                // Add new marker
                currentAttractionMarker = L.marker([attraction.lat, attraction.lng], {
                    isAttraction: true,
                    icon: L.divIcon({
                        html: '📍',
                        className: 'attraction-marker',
                        iconSize: [20, 20]
                    })
                }).addTo(map);

                currentAttractionMarker.bindPopup(`
                    <div class="popup-title">${attraction.name}</div>
                    <div>${attraction.type}</div>
                    <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">${attraction.distance} away</div>
                `).openPopup();
            });
        });

        // Control button handlers
        let userLocationMarker = null;

        // Listen for continuous location updates and always update attractions
        document.getElementById('locationBtn').addEventListener('click', () => {
            if (navigator.geolocation) {
                // Use watchPosition for continuous updates
                const watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        map.setView([lat, lng], 16);

                        // Remove previous user location marker if it exists
                        if (userLocationMarker) {
                            map.removeLayer(userLocationMarker);
                        }
                        // Add a new marker for the user's location
                        userLocationMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                html: '📍',
                                className: 'user-location-marker',
                                iconSize: [24, 24]
                            })
                        }).addTo(map);

                        userLocationMarker.bindPopup('<div class="popup-title">Your Location</div>').openPopup();

                        // Always update attractions list based on user's location
                        updateAttractionsList(lat, lng);

                        lastUserLocation = { lat, lng };
                    },
                    (error) => {
                        alert('Unable to retrieve your location. Please ensure location services are enabled.');
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );

                // Optional: Stop watching after a certain time or when not needed
                // setTimeout(() => navigator.geolocation.clearWatch(watchId), 60000); // Stop after 1 minute
            } else {
                alert('Geolocation is not supported by your browser.');
            }
        });

        document.getElementById('searchBtn').addEventListener('click', () => {
            const from = document.getElementById('fromInput').value;
            const to = document.getElementById('toInput').value;
            
            if (from && to) {
                planRoute(from, to);
            }
        });

        // Mobile responsiveness
        const sidebar = document.getElementById('sidebar');
        const mobileToggle = document.getElementById('mobileToggle');

        function checkMobile() {
            if (window.innerWidth <= 768) {
                mobileToggle.style.display = 'block';
            } else {
                mobileToggle.style.display = 'none';
                sidebar.classList.remove('open');
            }
        }

        mobileToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        window.addEventListener('resize', checkMobile);
        checkMobile();

        // Enhanced geocoding with better error handling
        async function geocodeLocation(query) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&addressdetails=1`,
                    {
                        headers: {
                            'User-Agent': 'TouristMaps/1.0'
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon),
                        name: data[0].display_name
                    };
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
            return null;
        }

        // Route planning using OpenRouteService (open source routing)
        async function planRoute(from, to) {
            showGlobalLoading(true);
            try {
                // Geocode locations using Nominatim
                const fromCoords = await geocodeLocation(from);
                const toCoords = await geocodeLocation(to);

                if (!fromCoords || !toCoords) {
                    alert('Could not find one or both locations. Please enter valid addresses.');
                    document.getElementById('routePanel').style.display = 'none';
                    return;
                }

                // Clear existing route
                if (routeControl) {
                    map.removeControl(routeControl);
                }

                // Create routing control with open-source routing
                const allLocations = [from, ...waypoints.filter(wp => wp.trim()), to];
                const coords = [];
                for (let loc of allLocations) {
                    const geo = await geocodeLocation(loc);
                    if (!geo) {
                        alert(`Could not find location: ${loc}`);
                        showGlobalLoading(false);
                        return;
                    }
                    coords.push(geo);
                }

                routeControl = L.Routing.control({
                    waypoints: coords.map(c => L.latLng(c.lat, c.lng)),
                    routeWhileDragging: true,
                    addWaypoints: false,
                    createMarker: function(i, waypoint, n) {
                        return L.marker(waypoint.latLng, {
                            draggable: true,
                            icon: L.divIcon({
                                html: i === 0 ? '🚩' : '🏁',
                                className: 'route-marker',
                                iconSize: [20, 20]
                            })
                        });
                    },
                    lineOptions: {
                        styles: [{
                            color: '#3b82f6',
                            weight: 4,
                            opacity: 0.8
                        }]
                    },
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                        profile: getOSRMProfile(currentRoute)
                    }),
                    show: false // Hide the default instruction panel
                }).on('routesfound', function(e) {
                    const route = e.routes[0];
                    const stats = {
                        distance: (route.summary.totalDistance / 1000).toFixed(1) + ' km',
                        time: Math.round(route.summary.totalTime / 60) + ' min',
                        attractions: countNearbyAttractions(route.coordinates)
                    };
                    
                    document.getElementById('routeDistance').textContent = stats.distance;
                    document.getElementById('routeTime').textContent = stats.time;
                    document.getElementById('routeAttractions').textContent = stats.attractions;
                }).addTo(map);

            } catch (error) {
                console.error('Routing error:', error);
                document.getElementById('routePanel').style.display = 'none';
            }
            showGlobalLoading(false);
        }

        // Map route types to OSRM profiles
        function getOSRMProfile() {
            switch(currentTransportMode) {
                case 'walking': return 'foot';
                case 'cycling': return 'bike';
                case 'driving': return 'car';
                case 'rail':
                    alert('Rail routing is not supported in this demo. Using driving directions instead.');
                    return 'car';
                case 'flying':
                    alert('Flying route is not supported. Showing straight line.');
                    return null;
                default: return 'car';
            }
        }

        // Count attractions near route
        function countNearbyAttractions(routeCoords) {
            if (!routeCoords) return '5'; // fallback
            
            let count = 0;
            attractions.forEach(attraction => {
                // Simple distance check (in a real app, you'd use proper geometric calculations)
                const isNearby = routeCoords.some(coord => {
                    const distance = Math.sqrt(
                        Math.pow(coord.lat - attraction.lat, 2) + 
                        Math.pow(coord.lng - attraction.lng, 2)
                    );
                    return distance < 0.02; // roughly 2km
                });
                if (isNearby) count++;
            });
            
            return count.toString();
        }

        // Enhanced attraction data with dynamic generation based on location
        function generateNearbyAttractions(lat, lng, radius = 0.05) {
            // Generate realistic attractions based on location with some randomization
            const attractionTypes = [
                { type: '🏛️ Museum', names: ['Art Museum', 'History Museum', 'Science Center', 'Cultural Center', 'Local Museum'] },
                { type: '🌳 Park', names: ['City Park', 'Memorial Park', 'Botanical Garden', 'Riverside Park', 'Community Garden'] },
                { type: '🎭 Entertainment', names: ['Theater District', 'Concert Hall', 'Cinema Complex', 'Performance Center', 'Arts Center'] },
                { type: '🌉 Landmark', names: ['Historic Bridge', 'City Hall', 'Monument', 'Memorial', 'Clock Tower'] },
                { type: '🍽️ Restaurant', names: ['Local Bistro', 'Rooftop Restaurant', 'Café Corner', 'Traditional Cuisine', 'Food Market'] },
                { type: '🎯 Attraction', names: ['Observation Deck', 'Walking Tour Start', 'Photo Spot', 'Visitor Center', 'Tourist Info'] },
                { type: '🏰 Historic', names: ['Historic District', 'Old Town', 'Heritage Site', 'Ancient Building', 'Historic Square'] },
                { type: '🌄 Viewpoint', names: ['Scenic Overlook', 'City Viewpoint', 'Panoramic View', 'Sunset Point', 'Photo Lookout'] }
            ];

            const generatedAttractions = [];
            
            // Generate 8-12 attractions around the area
            const numAttractions = 8 + Math.floor(Math.random() * 5);
            
            for (let i = 0; i < numAttractions; i++) {
                const typeData = attractionTypes[Math.floor(Math.random() * attractionTypes.length)];
                const name = typeData.names[Math.floor(Math.random() * typeData.names.length)];
                
                // Generate coordinates within radius
                const offsetLat = (Math.random() - 0.5) * radius * 2;
                const offsetLng = (Math.random() - 0.5) * radius * 2;
                
                const attractionLat = lat + offsetLat;
                const attractionLng = lng + offsetLng;
                
                generatedAttractions.push({
                    name: name,
                    type: typeData.type,
                    lat: attractionLat,
                    lng: attractionLng,
                    distance: calculateDistance(lat, lng, attractionLat, attractionLng).toFixed(1) + ' km'
                });
            }
            
            // Sort by distance
            return generatedAttractions.sort((a, b) => 
                parseFloat(a.distance) - parseFloat(b.distance)
            );
        }

        // Fallback to Nominatim for POI search (more reliable for CORS)
        async function fetchNearbyAttractions(lat, lng, radius = 5000) {
            try {
                // Try to fetch from Nominatim search for tourism POIs
                const queries = [
                    `tourism=museum&lat=${lat}&lon=${lng}`,
                    `tourism=attraction&lat=${lat}&lon=${lng}`,
                    `leisure=park&lat=${lat}&lon=${lng}`
                ];
                
                const attractions = [];
                
                for (const query of queries) {
                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/search?format=json&${query}&radius=5000&limit=5`,
                            {
                                headers: {
                                    'User-Agent': 'TouristMaps/1.0'
                                }
                            }
                        );
                        
                        if (response.ok) {
                            const data = await response.json();
                            data.forEach(item => {
                                if (item.display_name && item.lat && item.lon) {
                                    attractions.push({
                                        name: item.display_name.split(',')[0],
                                        type: getAttractionTypeFromQuery(query),
                                        lat: parseFloat(item.lat),
                                        lng: parseFloat(item.lon),
                                        distance: calculateDistance(lat, lng, parseFloat(item.lat), parseFloat(item.lon)).toFixed(1) + ' km'
                                    });
                                }
                            });
                        }
                    } catch (e) {
                        console.log('Skipping query due to error:', e);
                    }
                }
                
                // If we got some results, return them, otherwise generate
                if (attractions.length > 0) {
                    return attractions.slice(0, 10);
                } else {
                    return generateNearbyAttractions(lat, lng);
                }
                
            } catch (error) {
                console.log('Using generated attractions due to API limitations');
                return generateNearbyAttractions(lat, lng);
            }
        }

        function getAttractionTypeFromQuery(query) {
            if (query.includes('museum')) return '🏛️ Museum';
            if (query.includes('attraction')) return '🎯 Attraction';
            if (query.includes('park')) return '🌳 Park';
            return '📍';
        }

        function getAttractionEmoji(type) {
    if (type.includes('Museum')) return '🏛️';
    if (type.includes('Park')) return '🌳';
    if (type.includes('Entertainment')) return '🎭';
    if (type.includes('Landmark')) return '🌉';
    if (type.includes('Restaurant')) return '🍽️';
    if (type.includes('Attraction')) return '🎯';
    if (type.includes('Historic')) return '🏰';
    if (type.includes('Viewpoint')) return '🌄';
    return '📍';
}

        function getAttractionIcon(tags) {
            if (tags.tourism === 'museum' || tags.tourism === 'gallery') return '🏛️ Museum';
            if (tags.tourism === 'attraction') return '🎯 Attraction';
            if (tags.tourism === 'viewpoint') return '🌄 Viewpoint';
            if (tags.tourism === 'zoo') return '🦁 Zoo';
            if (tags.amenity === 'theatre') return '🎭 Theatre';
            if (tags.amenity === 'cinema') return '🎬 Cinema';
            if (tags.amenity === 'restaurant') return '🍽️ Restaurant';
            if (tags.leisure === 'park' || tags.leisure === 'garden') return '🌳 Park';
            if (tags.historic) return '🏛️ Historic Site';
            return '📍 Point of Interest';
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function getRouteStats(routeType) {
            const stats = {
                fastest: { distance: '12.4 km', time: '28 min', attractions: '5' },
                shortest: { distance: '10.8 km', time: '35 min', attractions: '3' },
                scenic: { distance: '16.2 km', time: '42 min', attractions: '8' },
                tourist: { distance: '14.7 km', time: '55 min', attractions: '12' }
            };
            return stats[routeType] || stats.fastest;
        }

        // Update attractions list dynamically with better error handling
        async function updateAttractionsList(lat, lng) {
            showGlobalLoading(true);
            try {
                const attractionsList = document.getElementById('attractionsList');
                attractionsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #94a3b8;">🔍 Discovering attractions...</div>';
                
                const nearbyAttractions = await fetchNearbyAttractions(lat, lng);
                attractionsList.innerHTML = '';
                
                if (nearbyAttractions && nearbyAttractions.length > 0) {
                    attractionCluster.clearLayers();
nearbyAttractions.slice(0, 10).forEach((attraction, index) => {
    const item = document.createElement('div');
    item.className = 'attraction-item';
    item.innerHTML = `
        <div class="attraction-name">${attraction.name}</div>
        <div class="attraction-type">${attraction.type}</div>
        <div class="attraction-distance">${attraction.distance} away</div>
        <button class="star-btn" title="Add to favorites">★</button>
    `;
    item.querySelector('.star-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        saveFavorite({
            name: attraction.name,
            lat: attraction.lat,
            lng: attraction.lng
        });
        renderRecentAndFavorites();
    });

    // Create a clustered marker with a custom emoji icon
    const marker = L.marker([attraction.lat, attraction.lng], {
        icon: L.divIcon({
            html: getAttractionEmoji(attraction.type),
            className: 'attraction-marker',
            iconSize: [24, 24]
        })
    });

    // Wikipedia-enhanced popup
    marker.on('click', async () => {
        marker.bindPopup(`
            <div class="popup-title">${attraction.name}</div>
            <div>${attraction.type}</div>
            <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">${attraction.distance} away</div>
            <div style="color:#64748b;font-size:12px;margin-top:8px;">Loading info...</div>
        `).openPopup();
        const wiki = await fetchWikipediaSummary(attraction.name);
        let extra = '';
        if (wiki && (wiki.extract || wiki.image)) {
            if (wiki.image) {
                extra += `<img src="${wiki.image}" alt="${attraction.name}" style="width:100%;max-width:180px;border-radius:8px;margin:8px 0;">`;
            }
            if (wiki.extract) {
                extra += `<div style="font-size:12px;color:#64748b;margin-top:4px;">${wiki.extract}</div>`;
            }
            if (wiki.url) {
                extra += `<div style="margin-top:6px;"><a href="${wiki.url}" target="_blank" style="font-size:12px;color:#3b82f6;">Read more on Wikipedia</a></div>`;
            }
        } else {
            extra += `<div style="font-size:12px;color:#64748b;margin-top:4px;">No extra info found.</div>`;
        }
        marker.setPopupContent(`
            <div class="popup-title">${attraction.name}</div>
            <div>${attraction.type}</div>
            <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">${attraction.distance} away</div>
            ${extra}
        `);
    });

    attractionCluster.addLayer(marker);

    item.addEventListener('click', () => {
        map.setView([attraction.lat, attraction.lng], 16);
        marker.openPopup();
    });

    attractionsList.appendChild(item);
});
                } else {
                    attractionsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #94a3b8;">🏞️ Move the map to discover attractions</div>';
                }
            } catch (error) {
                console.error('Error updating attractions:', error);
                attractionsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">❌ Unable to load attractions. Please check your connection or try again later.</div>';
            }
            showGlobalLoading(false);
        }

        // --- FIX 2: Use the same marker logic in displayAttractions ---
        function displayAttractions(attractions) {
            const attractionsList = document.getElementById('attractionsList');
            attractionsList.innerHTML = '';
            
            attractions.forEach((attraction, index) => {
                const item = document.createElement('div');
                item.className = 'attraction-item';
                item.innerHTML = `
                    <div class="attraction-name">${attraction.name}</div>
                    <div class="attraction-type">${attraction.type}</div>
                    <div class="attraction-distance">${attraction.distance} away</div>
                    <button class="star-btn" title="Add to favorites">★</button>
                `;
                item.querySelector('.star-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    saveFavorite({
                        name: attraction.name,
                        lat: attraction.lat,
                        lng: attraction.lng
                    });
                    renderRecentAndFavorites();
                });
                item.addEventListener('click', () => {
                    map.setView([attraction.lat, attraction.lng], 16);

                    // Remove previous marker if exists
                    if (currentAttractionMarker) {
                        map.removeLayer(currentAttractionMarker);
                    }
                    // Add new marker
                    currentAttractionMarker = L.marker([attraction.lat, attraction.lng], {
                        isAttraction: true,
                        icon: L.divIcon({
                            html: '📍',
                            className: 'attraction-marker',
                            iconSize: [20, 20]
                        })
                    }).addTo(map);

                    currentAttractionMarker.bindPopup(`
                        <div class="popup-title">${attraction.name}</div>
                        <div>${attraction.type}</div>
                        <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">${attraction.distance} away</div>
                    `).openPopup();
                });
                attractionsList.appendChild(item);
            });
        }

        // --- FIX 3: Remove broken attractionMarkers array logic ---
        // Remove this block (it references undefined variables and is not needed):
        /*
        document.querySelectorAll('.attraction-item').forEach((item, index) => {
            item.addEventListener('click', () => {
                const attraction = attractions[index];
                map.setView([attraction.lat, attraction.lng], 16);
                attractionMarkers[index].openPopup();
            });
        });
        */

        // --- FIX 4: Allow pressing Enter in input fields to trigger route planning ---
        document.getElementById('fromInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') updateRoute();
        });
        document.getElementById('toInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') updateRoute();
        });

        // --- FIX 5: Hide route panel if no route is planned ---
        function updateRoute() {
            const from = document.getElementById('fromInput').value;
            const to = document.getElementById('toInput').value;
            
            if (from && to) {
                planRoute(from, to);
            } else {
                document.getElementById('routePanel').style.display = 'none';
            }
        }

        // --- FIX 6: Professional alert for geocoding failure ---
        async function planRoute(from, to) {
            showGlobalLoading(true);
            try {
                // Geocode locations using Nominatim
                const fromCoords = await geocodeLocation(from);
                const toCoords = await geocodeLocation(to);

                if (!fromCoords || !toCoords) {
                    alert('Could not find one or both locations. Please enter valid addresses.');
                    document.getElementById('routePanel').style.display = 'none';
                    return;
                }

                // Clear existing route
                if (routeControl) {
                    map.removeControl(routeControl);
                }

                // Create routing control with open-source routing
                const allLocations = [from, ...waypoints.filter(wp => wp.trim()), to];
                const coords = [];
                for (let loc of allLocations) {
                    const geo = await geocodeLocation(loc);
                    if (!geo) {
                        alert(`Could not find location: ${loc}`);
                        showGlobalLoading(false);
                        return;
                    }
                    coords.push(geo);
                }

                routeControl = L.Routing.control({
                    waypoints: coords.map(c => L.latLng(c.lat, c.lng)),
                    routeWhileDragging: true,
                    addWaypoints: false,
                    createMarker: function(i, waypoint, n) {
                        return L.marker(waypoint.latLng, {
                            draggable: true,
                            icon: L.divIcon({
                                html: i === 0 ? '🚩' : '🏁',
                                className: 'route-marker',
                                iconSize: [20, 20]
                            })
                        });
                    },
                    lineOptions: {
                        styles: [{
                            color: '#3b82f6',
                            weight: 4,
                            opacity: 0.8
                        }]
                    },
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                        profile: getOSRMProfile(currentRoute)
                    }),
                    show: false // Hide the default instruction panel
                }).on('routesfound', function(e) {
                    const route = e.routes[0];
                    const stats = {
                        distance: (route.summary.totalDistance / 1000).toFixed(1) + ' km',
                        time: Math.round(route.summary.totalTime / 60) + ' min',
                        attractions: countNearbyAttractions(route.coordinates)
                    };
                    
                    document.getElementById('routeDistance').textContent = stats.distance;
                    document.getElementById('routeTime').textContent = stats.time;
                    document.getElementById('routeAttractions').textContent = stats.attractions;
                }).addTo(map);

            } catch (error) {
                console.error('Routing error:', error);
                document.getElementById('routePanel').style.display = 'none';
            }
            showGlobalLoading(false);
        }

        let lastUserLocation = null;

        document.getElementById('layersBtn').addEventListener('click', () => {
    // On mobile, open the sidebar to show layer options
    if (window.innerWidth <= 768) {
        sidebar.classList.toggle('open');
        // Optionally scroll to the layers section
        const layersSection = document.querySelector('.map-layers');
        if (layersSection) layersSection.scrollIntoView({ behavior: 'smooth' });
    } else {
        // On desktop, scroll to layers section in sidebar
        const layersSection = document.querySelector('.map-layers');
        if (layersSection) layersSection.scrollIntoView({ behavior: 'smooth' });
    }
});

        // Save and load user preferences
function savePreference(key, value) {
    try { localStorage.setItem(key, value); } catch (e) {}
}
function loadPreference(key, fallback) {
    try {
        const val = localStorage.getItem(key);
        return val !== null ? val : fallback;
    } catch (e) { return fallback; }
}

// Set active transport mode
document.querySelectorAll('.transport-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === currentTransportMode);
});
// Set active route type
document.querySelectorAll('.route-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.route === currentRouteType);
});
// Set active map layer
document.querySelectorAll('.layer-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.layer === currentLayer);
});

        // Theme toggle logic
        const themeToggle = document.getElementById('themeToggle');
        function setTheme(mode) {
            if (mode === 'light') {
                document.body.classList.add('light-mode');
                themeToggle.textContent = '🌞';
            } else {
                document.body.classList.remove('light-mode');
                themeToggle.textContent = '🌙';
            }
            savePreference('theme', mode);
        }
        themeToggle.addEventListener('click', () => {
            const newMode = document.body.classList.contains('light-mode') ? 'dark' : 'light';
            setTheme(newMode);
        });
        // On load, set theme from preference
        setTheme(loadPreference('theme', 'dark'));

        function saveRecentSearch(from, to) {
    let recent = [];
    try { recent = JSON.parse(localStorage.getItem('recentSearches')) || []; } catch {}
    // Remove duplicates
    recent = recent.filter(item => !(item.from === from && item.to === to));
    recent.unshift({from, to});
    if (recent.length > 5) recent = recent.slice(0, 5);
    localStorage.setItem('recentSearches', JSON.stringify(recent));
}
function getRecentSearches() {
    try { return JSON.parse(localStorage.getItem('recentSearches')) || []; } catch { return []; }
}
function saveFavorite(place) {
    let favs = [];
    try { favs = JSON.parse(localStorage.getItem('favoritePlaces')) || []; } catch {}
    if (!favs.find(f => f.name === place.name && f.lat === place.lat && f.lng === place.lng)) {
        favs.unshift(place);
        if (favs.length > 5) favs = favs.slice(0, 5);
        localStorage.setItem('favoritePlaces', JSON.stringify(favs));
    }
}
function getFavorites() {
    try { return JSON.parse(localStorage.getItem('favoritePlaces')) || []; } catch { return []; }
}
function renderRecentAndFavorites() {
    // Recent
    const recentList = document.getElementById('recentList');
    const recent = getRecentSearches();
    recentList.innerHTML = recent.length ? recent.map(item =>
        `<div class="recent-item" data-from="${item.from}" data-to="${item.to}" tabindex="0" role="button">
            <span>From: <b>${item.from}</b> → To: <b>${item.to}</b></span>
        </div>`
    ).join('') : '<div style="color:#94a3b8;font-size:12px;">No recent searches</div>';
    // Click to fill inputs
    recentList.querySelectorAll('.recent-item').forEach(item => {
        item.addEventListener('click', () => {
            document.getElementById('fromInput').value = item.dataset.from;
            document.getElementById('toInput').value = item.dataset.to;
            updateRoute();
        });
        item.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') item.click();
    });
    });
    // Favorites
    const favoritesList = document.getElementById('favoritesList');
    const favs = getFavorites();
    favoritesList.innerHTML = favs.length ? favs.map(place =>
        `<div class="favorite-item" data-lat="${place.lat}" data-lng="${place.lng}" data-name="${place.name}" tabindex="0" role="button">
            <span>★ ${place.name}</span>
        </div>`
    ).join('') : '<div style="color:#94a3b8;font-size:12px;">No favorites yet</div>';
    favoritesList.querySelectorAll('.favorite-item').forEach(item => {
        item.addEventListener('click', () => {
            map.setView([item.dataset.lat, item.dataset.lng], 16);
        });
        item.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') item.click();
    });
    });
}
document.getElementById('shareRouteBtn').addEventListener('click', () => {
    const from = encodeURIComponent(document.getElementById('fromInput').value);
    const to = encodeURIComponent(document.getElementById('toInput').value);
    const mode = encodeURIComponent(currentTransportMode);
    const type = encodeURIComponent(currentRouteType);
    const url = `${location.origin}${location.pathname}?from=${from}&to=${to}&mode=${mode}&type=${type}`;
    navigator.clipboard.writeText(url).then(() => {
        alert('Shareable route link copied to clipboard!');
    }, () => {
        prompt('Copy this link:', url);
    });
});
window.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const from = params.get('from');
    const to = params.get('to');
    const mode = params.get('mode');
    const type = params.get('type');
    if (from) document.getElementById('fromInput').value = decodeURIComponent(from);
    if (to) document.getElementById('toInput').value = decodeURIComponent(to);
    if (mode) {
        currentTransportMode = mode;
        document.querySelectorAll('.transport-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
    }
    if (type) {
        currentRouteType = type;
        document.querySelectorAll('.route-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.route === type);
        });
    }
    if (from && to) {
        updateRoute();
    }
});
document.getElementById('printRouteBtn').addEventListener('click', () => {
    window.print();
});

function showGlobalLoading(show) {
    document.getElementById('globalLoading').style.display = show ? 'flex' : 'none';
}

async function fetchWikipediaSummary(title) {
    try {
        const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
        const response = await fetch(url);
        if (!response.ok) return null;
        const data = await response.json();
        return {
            extract: data.extract,
            image: data.thumbnail ? data.thumbnail.source : null,
            url: data.content_urls ? data.content_urls.desktop.page : null
        };
    } catch {
        return null;
    }
}

// Register service worker for offline support
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(
        reg => console.log('Service worker registered.', reg),
        err => console.warn('Service worker registration failed.', err)
    );
}

let waypoints = [];

function renderWaypoints() {
    const container = document.getElementById('waypointsContainer');
    container.innerHTML = '';
    waypoints.forEach((wp, idx) => {
        const div = document.createElement('div');
        div.className = 'input-group';
        div.innerHTML = `
            <label class="input-label">Stop ${idx + 1}</label>
            <input type="text" class="input-field waypoint-input" data-idx="${idx}" value="${wp}" placeholder="Enter stop location">
            <button class="control-btn remove-waypoint-btn" data-idx="${idx}" title="Remove stop" style="width:32px;height:32px;font-size:16px;margin-left:4px;">✖️</button>
        `;
        container.appendChild(div);
    });
    // Remove handlers
    container.querySelectorAll('.remove-waypoint-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const idx = parseInt(btn.dataset.idx);
            waypoints.splice(idx, 1);
            renderWaypoints();
        });
    });
    // Update handlers
    container.querySelectorAll('.waypoint-input').forEach(input => {
        input.addEventListener('input', (e) => {
            waypoints[parseInt(input.dataset.idx)] = input.value;
        });
    });
}
document.getElementById('addWaypointBtn').addEventListener('click', () => {
    waypoints.push('');
    renderWaypoints();
});
renderWaypoints();

document.getElementById('weatherBtn').addEventListener('click', async () => {
    const panel = document.getElementById('weatherPanel');
    const center = map.getCenter();
    panel.style.display = 'block';
    panel.innerHTML = 'Loading weather...';

    // Open-Meteo API (no key required)
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${center.lat.toFixed(4)}&longitude=${center.lng.toFixed(4)}&current_weather=true`;

    try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Weather fetch failed');
        const data = await res.json();
        if (data.current_weather) {
            const w = data.current_weather;
            panel.innerHTML = `
                <div style="font-size:18px;font-weight:600;margin-bottom:4px;">Weather</div>
                <div style="font-size:32px;">${getWeatherEmoji(w.weathercode)}</div>
                <div><b>${w.temperature}°C</b> &nbsp;|&nbsp; ${getWeatherDesc(w.weathercode)}</div>
                <div style="font-size:13px;color:#94a3b8;margin-top:4px;">Wind: ${w.windspeed} km/h</div>
                <button id="closeWeatherBtn" style="margin-top:10px;background:none;border:none;color:#f8fafc;font-size:16px;cursor:pointer;">Close</button>
            `;
            document.getElementById('closeWeatherBtn').onclick = () => panel.style.display = 'none';
        } else {
            panel.innerHTML = 'No weather data available.';
        }
    } catch {
        panel.innerHTML = 'Unable to load weather.';
    }
});

// Weather code helpers
function getWeatherEmoji(code) {
    if ([0].includes(code)) return '☀️';
    if ([1,2,3].includes(code)) return '⛅';
    if ([45,48].includes(code)) return '🌫️';
    if ([51,53,55,56,57,61,63,65,66,67,80,81,82].includes(code)) return '🌦️';
    if ([71,73,75,77,85,86].includes(code)) return '❄️';
    if ([95,96,99].includes(code)) return '⛈️';
    return '☁️';
}
function getWeatherDesc(code) {
    const map = {
        0: 'Clear sky', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
        45: 'Fog', 48: 'Depositing rime fog',
        51: 'Light drizzle', 53: 'Drizzle', 55: 'Dense drizzle',
        56: 'Freezing drizzle', 57: 'Freezing drizzle',
        61: 'Slight rain', 63: 'Rain', 65: 'Heavy rain',
        66: 'Freezing rain', 67: 'Freezing rain',
        71: 'Slight snow', 73: 'Snow', 75: 'Heavy snow', 77: 'Snow grains',
        80: 'Rain showers', 81: 'Rain showers', 82: 'Violent rain showers',
        85: 'Snow showers', 86: 'Heavy snow showers',
        95: 'Thunderstorm', 96: 'Thunderstorm', 99: 'Thunderstorm'
    };
    return map[code] || 'Cloudy';
}

// Language selection
const langSelect = document.getElementById('langSelect');
langSelect.addEventListener('change', (e) => {
    const lang = e.target.value;
    setLanguage(lang);
});

function setLanguage(lang) {
    if (translations[lang]) {
        Object.keys(translations[lang]).forEach(key => {
            const elements = document.querySelectorAll(`[data-i18n="${key}"]`);
            elements.forEach(el => {
                el.textContent = translations[lang][key];
            });
        });
    }
    savePreference('language', lang);
}

// On load, set language from preference
setLanguage(loadPreference('language', 'en'));

    </script>
</body>
</html>