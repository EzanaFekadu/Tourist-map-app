<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TouristMaps - Discover & Explore</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f172a;
            color: #f8fafc;
            overflow: hidden;
        }

        html, body {
            width: 100vw;
            height: 100vh;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        .sidebar {
            width: 100vw;
            min-width: 0;
            max-width: 100vw;
            border-radius: 0 0 18px 18px;
            box-shadow: 0 4px 32px rgba(0,0,0,0.18);
            position: relative;
            z-index: 1000;
            padding-bottom: 0;
        }

        .header {
            padding: 24px 16px 14px 16px;
            border-radius: 0 0 0 0;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tagline {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .search-section,
        .route-options,
        .map-layers,
        .attractions {
            padding-left: 16px;
            padding-right: 16px;
        }

        .search-section {
            padding: 20px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #cbd5e1;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            color: #f8fafc;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(15, 23, 42, 0.8);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .route-options {
            padding: 20px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .route-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .route-btn {
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            color: #cbd5e1;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .route-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .route-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-color: #3b82f6;
            color: white;
        }

        .map-layers {
            padding: 20px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .layer-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .layer-btn {
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            color: #cbd5e1;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .layer-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .layer-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: #10b981;
            color: white;
        }

        .attractions {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .attraction-item {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .attraction-item:hover {
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .attraction-name {
            font-size: 14px;
            font-weight: 600;
            color: #f8fafc;
            margin-bottom: 4px;
        }

        .attraction-type {
            font-size: 12px;
            color: #3b82f6;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .attraction-distance {
            font-size: 11px;
            color: #94a3b8;
        }

        .map-container {
            flex: 1;
            min-height: 300px;
            position: relative;
            width: 100vw;
            height: 100%;
        }

        #map {
            width: 100vw;
            height: 60vh;
            min-height: 300px;
        }

        .map-controls {
            position: absolute;
            top: unset;
            bottom: 16px;
            right: 16px;
            left: unset;
            flex-direction: row;
            gap: 8px;
        }

        .control-btn {
            width: 44px;
            height: 44px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            color: #f8fafc;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: rgba(59, 130, 246, 0.9);
            border-color: #3b82f6;
            transform: scale(1.05);
        }

        .floating-panel {
            position: absolute;
            left: 8px;
            right: 8px;
            bottom: 80px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 14px;
            color: #f8fafc;
            z-index: 1000;
            display: none;
        }

        .route-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .route-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-weight: 600;
            color: #3b82f6;
        }

        .stat-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(148, 163, 184, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);
            width: 0%;
            transition: width 2s ease;
        }

        .leaflet-popup-content-wrapper {
            background: rgba(15, 23, 42, 0.95);
            color: #f8fafc;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .leaflet-popup-content {
            margin: 12px 16px;
            font-size: 14px;
        }

        .popup-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #3b82f6;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 350px;
                position: absolute;
                left: -100%;
                transition: left 0.3s ease;
                z-index: 2000;
            }

            .sidebar.open {
                left: 0;
            }

            .mobile-toggle {
                display: block !important;
                position: absolute;
                top: 16px;
                left: 16px;
                z-index: 1100;
                background: rgba(15, 23, 42, 0.95);
                border: 1px solid rgba(148, 163, 184, 0.2);
                border-radius: 8px;
                padding: 8px 12px;
                color: #f8fafc;
                font-size: 20px;
                cursor: pointer;
            }
        }

        /* --- Mobile-First Enhancements --- */

        /* Base styles: assume mobile first */
        body, html {
            width: 100vw;
            height: 100vh;
            min-height: 100vh;
            overflow-x: hidden;
            background: #0f172a;
        }

        .container {
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        .sidebar {
            width: 100vw;
            min-width: 0;
            max-width: 100vw;
            border-radius: 0 0 18px 18px;
            box-shadow: 0 4px 32px rgba(0,0,0,0.18);
            position: relative;
            z-index: 1000;
            padding-bottom: 0;
        }

        .header {
            padding: 24px 16px 14px 16px;
            border-radius: 0 0 0 0;
        }

        .search-section,
        .route-options,
        .map-layers,
        .attractions {
            padding-left: 16px;
            padding-right: 16px;
        }

        .map-container {
            flex: 1;
            min-height: 300px;
            position: relative;
            width: 100vw;
            height: 100%;
        }

        #map {
            width: 100vw;
            height: 60vh;
            min-height: 300px;
        }

        .map-controls {
            top: unset;
            bottom: 16px;
            right: 16px;
            left: unset;
            flex-direction: row;
            gap: 8px;
        }

        .floating-panel {
            left: 8px;
            right: 8px;
            bottom: 80px;
            border-radius: 12px;
            padding: 14px;
        }

        .mobile-toggle {
            display: block !important;
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 1100;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: #f8fafc;
            font-size: 20px;
            cursor: pointer;
        }

        .sidebar {
            position: absolute;
            top: 0;
            left: -100vw;
            height: 100vh;
            transition: left 0.3s cubic-bezier(.4,0,.2,1);
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            overflow-y: auto;
        }
        .sidebar.open {
            left: 0;
        }

        @media (min-width: 769px) {
            .container {
                flex-direction: row;
            }
            .sidebar {
                position: relative;
                width: 370px;
                max-width: 370px;
                left: 0;
                border-radius: 0 18px 18px 0;
                height: 100vh;
                overflow-y: auto;
            }
            .map-container {
                height: 100vh;
                width: calc(100vw - 370px);
            }
            #map {
                height: 100vh;
                width: 100%;
            }
            .map-controls {
                flex-direction: column;
                top: 20px;
                bottom: unset;
                right: 20px;
                left: unset;
            }
            .floating-panel {
                left: 24px;
                right: 24px;
                bottom: 24px;
                border-radius: 18px;
                padding: 24px;
            }
            .mobile-toggle {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="header">
                <div class="logo">
                    üó∫Ô∏è TouristMaps
                </div>
                <div class="tagline">Discover amazing places on your journey</div>
            </div>

            <div class="search-section">
                <div class="input-group">
                    <label class="input-label">From</label>
                    <input type="text" class="input-field" id="fromInput" placeholder="Enter starting location">
                </div>
                <div class="input-group">
                    <label class="input-label">To</label>
                    <input type="text" class="input-field" id="toInput" placeholder="Enter destination">
                </div>
            </div>

            <div class="route-options">
                <div class="section-title">Route Type</div>
                <div class="route-buttons">
                    <button class="route-btn active" data-route="fastest">‚ö° Fastest</button>
                    <button class="route-btn" data-route="shortest">üìè Shortest</button>
                    <button class="route-btn" data-route="scenic">üåÑ Scenic</button>
                    <button class="route-btn" data-route="tourist">üéØ Tourist</button>
                </div>
            </div>

            <div class="map-layers">
                <div class="section-title">Map Layers</div>
                <div class="layer-buttons">
                    <button class="layer-btn active" data-layer="standard">üó∫Ô∏è Standard</button>
                    <button class="layer-btn" data-layer="satellite">üõ∞Ô∏è Satellite</button>
                    <button class="layer-btn" data-layer="terrain">‚õ∞Ô∏è Terrain</button>
                    <button class="layer-btn" data-layer="traffic">üö¶ Traffic</button>
                    <button class="layer-btn" data-layer="transit">üöã Transit</button>
                </div>
            </div>

            <div class="attractions">
                <div class="section-title">Nearby Attractions</div>
                <div id="attractionsList">
                </div>
            </div>
        </div>

        <div class="map-container">
            <button class="mobile-toggle" id="mobileToggle" style="display: none;">‚ò∞</button>
            <div id="map"></div>
            
            <div class="map-controls">
                <button class="control-btn" id="locationBtn" title="My Location">üìç</button>
                <button class="control-btn" id="searchBtn" title="Search">üîç</button>
                <button class="control-btn" id="layersBtn" title="Layers">üóÇÔ∏è</button>
            </div>

            <div class="floating-panel" id="routePanel">
                <div class="route-info">
                    <div class="route-stats">
                        <div class="stat">
                            <div class="stat-value" id="routeDistance">12.4 mi</div>
                            <div class="stat-label">Distance</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="routeTime">28 min</div>
                            <div class="stat-label">Time</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="routeAttractions">5</div>
                            <div class="stat-label">Attractions</div>
                        </div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>
    <script>
        // Define constants
        const DEFAULT_LAT = 40.7128;
        const DEFAULT_LNG = -74.0060;
        const DEFAULT_ZOOM = 13;
        const NOMINATIM_URL = 'https://nominatim.openstreetmap.org/search?format=json';
        const OSRM_URL = 'https://router.project-osrm.org/route/v1';
        const USER_AGENT = 'TouristMaps/1.0';
        const NEARBY_ATTRACTION_RADIUS_KM = 5;
        const EARTH_RADIUS_KM = 6371;
        const NOMINATIM_SEARCH_LIMIT = 5;
        const DISPLAY_ATTRACTION_LIMIT = 10;
        const ROUTE_NEARBY_DISTANCE_THRESHOLD = 0.02; // Approx 2km in crude lat/lng distance
        const DEFAULT_ATTRACTIONS_COUNT_FALLBACK = 5;
        const MIN_GENERATED_ATTRACTIONS = 8;
        const MAX_GENERATED_ATTRACTIONS_RANDOM = 5;
        const INITIAL_LOAD_DELAY = 1000;
        const MARKER_ICON_SIZE = [20, 20];
        const POPUP_TEXT_COLOR = '#94a3b8';
        const POPUP_TEXT_SIZE = '12px';
        const POPUP_TEXT_MARGIN_TOP = '4px';

        // Initialize the map
        const map = L.map('map').setView([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);

        // Map layers - All open source
        const layers = {
            standard: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }),
            satellite: L.tileLayer('https://tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, hillshading by <a href="https://wmflabs.org/">Wikimedia Labs</a>'
            }),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | ¬© <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
            }),
            traffic: L.tileLayer('https://api.maptiler.com/maps/traffic/{z}/{x}/{y}.png?key=YOUR_MAPTILER_KEY', {
                attribution: 'MapTiler Traffic ¬© MapTiler',
                maxZoom: 20
            }),
            transit: null, // We'll manage this with dynamic markers
        };

        // Set default layer
        layers.standard.addTo(map);
        let currentLayer = 'standard';

        let transitMarkers = [];

        async function showTransitStops(lat, lng, radius = 1000) {
            // Remove old markers
            transitMarkers.forEach(marker => map.removeLayer(marker));
            transitMarkers = [];
        
            // Query Transitland for stops near the center of the map
            const url = `https://transit.land/api/v2/rest/stops?lat=${lat}&lon=${lng}&r=${radius}`;
            const response = await fetch(url);
            if (!response.ok) return;
            const data = await response.json();
        
            if (data.stops) {
                data.stops.forEach(stop => {
                    const coords = stop.geometry.coordinates;
                    const marker = L.circleMarker([coords[1], coords[0]], {
                        radius: 5,
                        color: 'purple',
                        fillColor: 'white',
                        fillOpacity: 0.9
                    }).bindPopup(`<b>${stop.name}</b>`).addTo(map);
                    transitMarkers.push(marker);
                });
            }
        }

        // Route planning variables
        let routeControl;
        let currentRoute = 'fastest';

        // Event listeners for route buttons
        document.querySelectorAll('.route-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.route-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentRoute = btn.dataset.route;
                updateRoute();
            });
        });

        // Event listeners for layer buttons
        document.querySelectorAll('.layer-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const layerType = btn.dataset.layer;
                if (currentLayer === 'transit') {
                    // Remove transit markers when leaving the transit layer
                    transitMarkers.forEach(marker => map.removeLayer(marker));
                }
                if (layerType === 'transit') {
                    // Show transit stops near map center
                    const center = map.getCenter();
                    showTransitStops(center.lat, center.lng);
                    currentLayer = 'transit';
                } else {
                    map.removeLayer(layers[currentLayer]);
                    layers[layerType].addTo(map);
                    currentLayer = layerType;
                }
                
                // Simulate traffic overlay for traffic layer
                if (layerType === 'traffic') {
                    setTimeout(() => {
                        // Add some visual indication of traffic (simplified)
                        map.setView([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);
                    }, 500);
                }
            });
        });

        map.on('moveend', function() {
            if (currentLayer === 'transit') {
                const center = map.getCenter();
                showTransitStops(center.lat, center.lng);
            }
        });

        // --- FIX 1: Remove duplicate marker logic and ensure only one attraction marker at a time ---
        let currentAttractionMarker = null;

        // Attraction item click handlers
        document.querySelectorAll('.attraction-item').forEach((item, index) => {
            item.addEventListener('click', () => {
                const attraction = attractions[index];
                map.setView([attraction.lat, attraction.lng], 16);

                // Remove previous marker if exists
                if (currentAttractionMarker) {
                    map.removeLayer(currentAttractionMarker);
                }
                // Add new marker
                currentAttractionMarker = L.marker([attraction.lat, attraction.lng], {
                    isAttraction: true,
                    icon: L.divIcon({
                        html: 'üìç',
                        className: 'attraction-marker',
                        iconSize: [20, 20]
                    })
                }).addTo(map);

                currentAttractionMarker.bindPopup(`
                    <div class="popup-title">${attraction.name}</div>
                    <div>${attraction.type}</div>
                    <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">${attraction.distance} away</div>
                `).openPopup();
            });
        });

        // Control button handlers
        let userLocationMarker = null;

        // Listen for continuous location updates and always update attractions
        document.getElementById('locationBtn').addEventListener('click', () => {
            if (navigator.geolocation) {
                // Use watchPosition for continuous updates
                const watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        map.setView([lat, lng], 16);

                        // Remove previous user location marker if it exists
                        if (userLocationMarker) {
                            map.removeLayer(userLocationMarker);
                        }
                        // Add a new marker for the user's location
                        userLocationMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                html: 'üìç',
                                className: 'user-location-marker',
                                iconSize: [24, 24]
                            })
                        }).addTo(map);

                        userLocationMarker.bindPopup('<div class="popup-title">Your Location</div>').openPopup();

                        // Always update attractions list based on user's location
                        updateAttractionsList(lat, lng);

                        lastUserLocation = { lat, lng };
                    },
                    (error) => {
                        alert('Unable to retrieve your location. Please ensure location services are enabled.');
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );

                // Optional: Stop watching after a certain time or when not needed
                // setTimeout(() => navigator.geolocation.clearWatch(watchId), 60000); // Stop after 1 minute
            } else {
                alert('Geolocation is not supported by your browser.');
            }
        });

        document.getElementById('searchBtn').addEventListener('click', () => {
            const from = document.getElementById('fromInput').value;
            const to = document.getElementById('toInput').value;
            
            if (from && to) {
                planRoute(from, to);
            }
        });

        // Mobile responsiveness
        const sidebar = document.getElementById('sidebar');
        const mobileToggle = document.getElementById('mobileToggle');

        function checkMobile() {
            if (window.innerWidth <= 768) {
                mobileToggle.style.display = 'block';
            } else {
                mobileToggle.style.display = 'none';
                sidebar.classList.remove('open');
            }
        }

        mobileToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        window.addEventListener('resize', checkMobile);
        checkMobile();

        // Enhanced geocoding with better error handling
        async function geocodeLocation(query) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&addressdetails=1`,
                    {
                        headers: {
                            'User-Agent': 'TouristMaps/1.0'
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon),
                        name: data[0].display_name
                    };
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
            return null;
        }

        // Route planning using OpenRouteService (open source routing)
        async function planRoute(from, to) {
            document.getElementById('routePanel').style.display = 'block';
            
            // Animate progress bar
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = '0%';
            setTimeout(() => {
                progressFill.style.width = '100%';
            }, 100);

            try {
                // Geocode locations using Nominatim
                const fromCoords = await geocodeLocation(from);
                const toCoords = await geocodeLocation(to);

                if (!fromCoords || !toCoords) {
                    alert('Could not find one or both locations. Please enter valid addresses.');
                    document.getElementById('routePanel').style.display = 'none';
                    return;
                }

                // Clear existing route
                if (routeControl) {
                    map.removeControl(routeControl);
                }

                // Create routing control with open-source routing
                routeControl = L.Routing.control({
                    waypoints: [
                        L.latLng(fromCoords.lat, fromCoords.lng),
                        L.latLng(toCoords.lat, toCoords.lng)
                    ],
                    routeWhileDragging: true,
                    addWaypoints: false,
                    createMarker: function(i, waypoint, n) {
                        return L.marker(waypoint.latLng, {
                            draggable: true,
                            icon: L.divIcon({
                                html: i === 0 ? 'üö©' : 'üèÅ',
                                className: 'route-marker',
                                iconSize: [20, 20]
                            })
                        });
                    },
                    lineOptions: {
                        styles: [{
                            color: '#3b82f6',
                            weight: 4,
                            opacity: 0.8
                        }]
                    },
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                        profile: getOSRMProfile(currentRoute)
                    }),
                    show: false // Hide the default instruction panel
                }).on('routesfound', function(e) {
                    const route = e.routes[0];
                    const stats = {
                        distance: (route.summary.totalDistance / 1000).toFixed(1) + ' km',
                        time: Math.round(route.summary.totalTime / 60) + ' min',
                        attractions: countNearbyAttractions(route.coordinates)
                    };
                    
                    document.getElementById('routeDistance').textContent = stats.distance;
                    document.getElementById('routeTime').textContent = stats.time;
                    document.getElementById('routeAttractions').textContent = stats.attractions;
                }).addTo(map);

            } catch (error) {
                console.error('Routing error:', error);
                document.getElementById('routePanel').style.display = 'none';
            }
        }

        // Map route types to OSRM profiles
        function getOSRMProfile(routeType) {
            switch(routeType) {
                case 'fastest': return 'driving';
                case 'shortest': return 'driving';
                case 'scenic': return 'driving';
                case 'tourist': return 'driving';
                default: return 'driving';
            }
        }

        // Count attractions near route
        function countNearbyAttractions(routeCoords) {
            if (!routeCoords) return '5'; // fallback
            
            let count = 0;
            attractions.forEach(attraction => {
                // Simple distance check (in a real app, you'd use proper geometric calculations)
                const isNearby = routeCoords.some(coord => {
                    const distance = Math.sqrt(
                        Math.pow(coord.lat - attraction.lat, 2) + 
                        Math.pow(coord.lng - attraction.lng, 2)
                    );
                    return distance < 0.02; // roughly 2km
                });
                if (isNearby) count++;
            });
            
            return count.toString();
        }

        // Enhanced attraction data with dynamic generation based on location
        function generateNearbyAttractions(lat, lng, radius = 0.05) {
            // Generate realistic attractions based on location with some randomization
            const attractionTypes = [
                { type: 'üèõÔ∏è Museum', names: ['Art Museum', 'History Museum', 'Science Center', 'Cultural Center', 'Local Museum'] },
                { type: 'üå≥ Park', names: ['City Park', 'Memorial Park', 'Botanical Garden', 'Riverside Park', 'Community Garden'] },
                { type: 'üé≠ Entertainment', names: ['Theater District', 'Concert Hall', 'Cinema Complex', 'Performance Center', 'Arts Center'] },
                { type: 'üåâ Landmark', names: ['Historic Bridge', 'City Hall', 'Monument', 'Memorial', 'Clock Tower'] },
                { type: 'üçΩÔ∏è Restaurant', names: ['Local Bistro', 'Rooftop Restaurant', 'Caf√© Corner', 'Traditional Cuisine', 'Food Market'] },
                { type: 'üéØ Attraction', names: ['Observation Deck', 'Walking Tour Start', 'Photo Spot', 'Visitor Center', 'Tourist Info'] },
                { type: 'üè∞ Historic', names: ['Historic District', 'Old Town', 'Heritage Site', 'Ancient Building', 'Historic Square'] },
                { type: 'üåÑ Viewpoint', names: ['Scenic Overlook', 'City Viewpoint', 'Panoramic View', 'Sunset Point', 'Photo Lookout'] }
            ];

            const generatedAttractions = [];
            
            // Generate 8-12 attractions around the area
            const numAttractions = 8 + Math.floor(Math.random() * 5);
            
            for (let i = 0; i < numAttractions; i++) {
                const typeData = attractionTypes[Math.floor(Math.random() * attractionTypes.length)];
                const name = typeData.names[Math.floor(Math.random() * typeData.names.length)];
                
                // Generate coordinates within radius
                const offsetLat = (Math.random() - 0.5) * radius * 2;
                const offsetLng = (Math.random() - 0.5) * radius * 2;
                
                const attractionLat = lat + offsetLat;
                const attractionLng = lng + offsetLng;
                
                generatedAttractions.push({
                    name: name,
                    type: typeData.type,
                    lat: attractionLat,
                    lng: attractionLng,
                    distance: calculateDistance(lat, lng, attractionLat, attractionLng).toFixed(1) + ' km'
                });
            }
            
            // Sort by distance
            return generatedAttractions.sort((a, b) => 
                parseFloat(a.distance) - parseFloat(b.distance)
            );
        }

        // Fallback to Nominatim for POI search (more reliable for CORS)
        async function fetchNearbyAttractions(lat, lng, radius = 5000) {
            try {
                // Try to fetch from Nominatim search for tourism POIs
                const queries = [
                    `tourism=museum&lat=${lat}&lon=${lng}`,
                    `tourism=attraction&lat=${lat}&lon=${lng}`,
                    `leisure=park&lat=${lat}&lon=${lng}`
                ];
                
                const attractions = [];
                
                for (const query of queries) {
                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/search?format=json&${query}&radius=5000&limit=5`,
                            {
                                headers: {
                                    'User-Agent': 'TouristMaps/1.0'
                                }
                            }
                        );
                        
                        if (response.ok) {
                            const data = await response.json();
                            data.forEach(item => {
                                if (item.display_name && item.lat && item.lon) {
                                    attractions.push({
                                        name: item.display_name.split(',')[0],
                                        type: getAttractionTypeFromQuery(query),
                                        lat: parseFloat(item.lat),
                                        lng: parseFloat(item.lon),
                                        distance: calculateDistance(lat, lng, parseFloat(item.lat), parseFloat(item.lon)).toFixed(1) + ' km'
                                    });
                                }
                            });
                        }
                    } catch (e) {
                        console.log('Skipping query due to error:', e);
                    }
                }
                
                // If we got some results, return them, otherwise generate
                if (attractions.length > 0) {
                    return attractions.slice(0, 10);
                } else {
                    return generateNearbyAttractions(lat, lng);
                }
                
            } catch (error) {
                console.log('Using generated attractions due to API limitations');
                return generateNearbyAttractions(lat, lng);
            }
        }

        function getAttractionTypeFromQuery(query) {
            if (query.includes('museum')) return 'üèõÔ∏è Museum';
            if (query.includes('attraction')) return 'üéØ Attraction';
            if (query.includes('park')) return 'üå≥ Park';
            return 'üìç Point of Interest';
        }

        function getAttractionIcon(tags) {
            if (tags.tourism === 'museum' || tags.tourism === 'gallery') return 'üèõÔ∏è Museum';
            if (tags.tourism === 'attraction') return 'üéØ Attraction';
            if (tags.tourism === 'viewpoint') return 'üåÑ Viewpoint';
            if (tags.tourism === 'zoo') return 'ü¶Å Zoo';
            if (tags.amenity === 'theatre') return 'üé≠ Theatre';
            if (tags.amenity === 'cinema') return 'üé¨ Cinema';
            if (tags.amenity === 'restaurant') return 'üçΩÔ∏è Restaurant';
            if (tags.leisure === 'park' || tags.leisure === 'garden') return 'üå≥ Park';
            if (tags.historic) return 'üèõÔ∏è Historic Site';
            return 'üìç Point of Interest';
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function getRouteStats(routeType) {
            const stats = {
                fastest: { distance: '12.4 km', time: '28 min', attractions: '5' },
                shortest: { distance: '10.8 km', time: '35 min', attractions: '3' },
                scenic: { distance: '16.2 km', time: '42 min', attractions: '8' },
                tourist: { distance: '14.7 km', time: '55 min', attractions: '12' }
            };
            return stats[routeType] || stats.fastest;
        }

        // Update attractions list dynamically with better error handling
        async function updateAttractionsList(lat, lng) {
            const attractionsList = document.getElementById('attractionsList');
            attractionsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #94a3b8;">üîç Discovering attractions...</div>';
            
            try {
                const nearbyAttractions = await fetchNearbyAttractions(lat, lng);
                attractionsList.innerHTML = '';
                
                if (nearbyAttractions && nearbyAttractions.length > 0) {
                    nearbyAttractions.slice(0, 10).forEach((attraction, index) => {
                        const item = document.createElement('div');
                        item.className = 'attraction-item';
                        item.innerHTML = `
                            <div class="attraction-name">${attraction.name}</div>
                            <div class="attraction-type">${attraction.type}</div>
                            <div class="attraction-distance">${attraction.distance} away</div>
                        `;
                        item.addEventListener('click', () => {
                            map.setView([attraction.lat, attraction.lng], 16);

                            // Remove previous marker if exists
                            if (currentAttractionMarker) {
                                map.removeLayer(currentAttractionMarker);
                            }
                            // Add new marker
                            currentAttractionMarker = L.marker([attraction.lat, attraction.lng], {
                                isAttraction: true,
                                icon: L.divIcon({
                                    html: 'üìç',
                                    className: 'attraction-marker',
                                    iconSize: [20, 20]
                                })
                            }).addTo(map);

                            currentAttractionMarker.bindPopup(`
                                <div class="popup-title">${attraction.name}</div>
                                <div>${attraction.type}</div>
                                <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">${attraction.distance} away</div>
                            `).openPopup();

                            // Chart route from user location to this attraction
                            if (lastUserLocation) {
                                if (routeControl) {
                                    map.removeControl(routeControl);
                                }
                                routeControl = L.Routing.control({
                                    waypoints: [
                                        L.latLng(lastUserLocation.lat, lastUserLocation.lng),
                                        L.latLng(attraction.lat, attraction.lng)
                                    ],
                                    routeWhileDragging: false,
                                    addWaypoints: false,
                                    createMarker: function(i, waypoint, n) {
                                        return L.marker(waypoint.latLng, {
                                            draggable: false,
                                            icon: L.divIcon({
                                                html: i === 0 ? 'üö©' : 'üèÅ',
                                                className: 'route-marker',
                                                iconSize: [20, 20]
                                            })
                                        });
                                    },
                                    lineOptions: {
                                        styles: [{
                                            color: '#3b82f6',
                                            weight: 4,
                                            opacity: 0.8
                                        }]
                                    },
                                    router: L.Routing.osrmv1({
                                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                                        profile: getOSRMProfile(currentRoute)
                                    }),
                                    show: false
                                }).on('routesfound', function(e) {
                                    const route = e.routes[0];
                                    document.getElementById('routePanel').style.display = 'block';
                                    document.getElementById('routeDistance').textContent = (route.summary.totalDistance / 1000).toFixed(1) + ' km';
                                    document.getElementById('routeTime').textContent = Math.round(route.summary.totalTime / 60) + ' min';
                                    document.getElementById('routeAttractions').textContent = '1';
                                }).addTo(map);
                            } else {
                                alert('User location not found. Please click the üìç button first.');
                            }
                        });
                        attractionsList.appendChild(item);
                    });
                } else {
                    attractionsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #94a3b8;">üèûÔ∏è Move the map to discover attractions</div>';
                }
            } catch (error) {
                console.error('Error updating attractions:', error);
                attractionsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #94a3b8;">üîÑ Unable to load attractions. Try moving the map.</div>';
            }
        }

        // --- FIX 2: Use the same marker logic in displayAttractions ---
        function displayAttractions(attractions) {
            const attractionsList = document.getElementById('attractionsList');
            attractionsList.innerHTML = '';
            
            attractions.forEach((attraction, index) => {
                const item = document.createElement('div');
                item.className = 'attraction-item';
                item.innerHTML = `
                    <div class="attraction-name">${attraction.name}</div>
                    <div class="attraction-type">${attraction.type}</div>
                    <div class="attraction-distance">${attraction.distance} away</div>
                `;
                item.addEventListener('click', () => {
                    map.setView([attraction.lat, attraction.lng], 16);

                    // Remove previous marker if exists
                    if (currentAttractionMarker) {
                        map.removeLayer(currentAttractionMarker);
                    }
                    // Add new marker
                    currentAttractionMarker = L.marker([attraction.lat, attraction.lng], {
                        isAttraction: true,
                        icon: L.divIcon({
                            html: 'üìç',
                            className: 'attraction-marker',
                            iconSize: [20, 20]
                        })
                    }).addTo(map);

                    currentAttractionMarker.bindPopup(`
                        <div class="popup-title">${attraction.name}</div>
                        <div>${attraction.type}</div>
                        <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">${attraction.distance} away</div>
                    `).openPopup();
                });
                attractionsList.appendChild(item);
            });
        }

        // --- FIX 3: Remove broken attractionMarkers array logic ---
        // Remove this block (it references undefined variables and is not needed):
        /*
        document.querySelectorAll('.attraction-item').forEach((item, index) => {
            item.addEventListener('click', () => {
                const attraction = attractions[index];
                map.setView([attraction.lat, attraction.lng], 16);
                attractionMarkers[index].openPopup();
            });
        });
        */

        // --- FIX 4: Allow pressing Enter in input fields to trigger route planning ---
        document.getElementById('fromInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') updateRoute();
        });
        document.getElementById('toInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') updateRoute();
        });

        // --- FIX 5: Hide route panel if no route is planned ---
        function updateRoute() {
            const from = document.getElementById('fromInput').value;
            const to = document.getElementById('toInput').value;
            
            if (from && to) {
                planRoute(from, to);
            } else {
                document.getElementById('routePanel').style.display = 'none';
            }
        }

        // --- FIX 6: Professional alert for geocoding failure ---
        async function planRoute(from, to) {
            document.getElementById('routePanel').style.display = 'block';
            
            // Animate progress bar
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = '0%';
            setTimeout(() => {
                progressFill.style.width = '100%';
            }, 100);

            try {
                // Geocode locations using Nominatim
                const fromCoords = await geocodeLocation(from);
                const toCoords = await geocodeLocation(to);

                if (!fromCoords || !toCoords) {
                    alert('Could not find one or both locations. Please enter valid addresses.');
                    document.getElementById('routePanel').style.display = 'none';
                    return;
                }

                // Clear existing route
                if (routeControl) {
                    map.removeControl(routeControl);
                }

                // Create routing control with open-source routing
                routeControl = L.Routing.control({
                    waypoints: [
                        L.latLng(fromCoords.lat, fromCoords.lng),
                        L.latLng(toCoords.lat, toCoords.lng)
                    ],
                    routeWhileDragging: true,
                    addWaypoints: false,
                    createMarker: function(i, waypoint, n) {
                        return L.marker(waypoint.latLng, {
                            draggable: true,
                            icon: L.divIcon({
                                html: i === 0 ? 'üö©' : 'üèÅ',
                                className: 'route-marker',
                                iconSize: [20, 20]
                            })
                        });
                    },
                    lineOptions: {
                        styles: [{
                            color: '#3b82f6',
                            weight: 4,
                            opacity: 0.8
                        }]
                    },
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                        profile: getOSRMProfile(currentRoute)
                    }),
                    show: false // Hide the default instruction panel
                }).on('routesfound', function(e) {
                    const route = e.routes[0];
                    const stats = {
                        distance: (route.summary.totalDistance / 1000).toFixed(1) + ' km',
                        time: Math.round(route.summary.totalTime / 60) + ' min',
                        attractions: countNearbyAttractions(route.coordinates)
                    };
                    
                    document.getElementById('routeDistance').textContent = stats.distance;
                    document.getElementById('routeTime').textContent = stats.time;
                    document.getElementById('routeAttractions').textContent = stats.attractions;
                }).addTo(map);

            } catch (error) {
                console.error('Routing error:', error);
                document.getElementById('routePanel').style.display = 'none';
            }
        }

        let lastUserLocation = null;
    </script>
</body>
</html>
